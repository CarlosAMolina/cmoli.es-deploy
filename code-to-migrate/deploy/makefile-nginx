DOCKER_CUSTOM_IMAGE_NAME=nginx-cmoli

run: pull-docker-image build-docker-image run-server wait-nginx-is-listening

pull-docker-image:
	docker pull nginx:latest

build-docker-image:
	docker build \
		-t $(DOCKER_CUSTOM_IMAGE_NAME) \
		-f Dockerfile-nginx \
		--build-arg docker_image= nginx:latest \
		.

#show logs: tail -f $(path of volume ngingx-logs)/access.log
run-server:
	docker run \
		-it \
		--rm \
		-d \
		-p 8080:80 \
		--name $(DOCKER_CUSTOM_IMAGE_NAME)-container \
		--mount type=volume,source=nginx-logs,target=/var/log/nginx \
		--mount type=volume,source=nginx-web-content,target=/usr/share/nginx/html,readonly \
		$(DOCKER_CUSTOM_IMAGE_NAME)

wait-nginx-is-listening:
	for !isNginxListening() {
	  sleep 5
	}

func isNginxListenin() {
	# https://everything.curl.dev/usingcurl/returns
	curl -s http://localhost:8080 > /dev/null
	exit_status=$?
	if test "$exit_status" == "0"; then
	  echo 0 # 0 = true
	else
	  echo 1 # 1 = false
	fi
}
